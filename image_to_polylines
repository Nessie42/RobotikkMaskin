import numpy as np
import cv2 as cv

# A4 og marger:
A4_W, A4_H = 210.0, 297.0     # mm (liggende/stående håndteres av skalering)
MARGIN = 8.0                  # mm
DRAW_W, DRAW_H = A4_W-2*MARGIN, A4_H-2*MARGIN

def image_to_polylines():
    path = cv.samples.findFile("Lenna_test.png") #getting image from file path
    image = cv.imread(path, cv.IMREAD_GRAYSCALE) #Grayscaling the image
    image = cv.GaussianBlur(image, (3,3),0) #Blurring the image to reduce noise
    edges = cv.Canny(image, 150, 200) #Creating borders to find lines in the image removed by threshold. [image, lower boundary, upper boundary]. The boundaries are values for intensity gradients, where values under lower are discarded and values over upper are kept as edges.
    k = np.ones((3, 3), np.uint8)
    edges = cv.morphologyEx(edges, cv.MORPH_CLOSE, k, iterations=1)
    edges = cv.dilate(edges, k, iterations=1)  # slår sammen tette linjer
    edges = cv.erode(edges, k, iterations=1)   # gjør linjene tynnere igjen
    _, thresh = cv.threshold(image, 120, 255, cv.THRESH_BINARY_INV) #Splitting the image by threshold: [image, threshold value, max value, method]. Any value over threshold value will be changed to white, all others to max value.
    contours_edge, _ = cv.findContours(edges, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE) #Finding contours:

    cnts, _ = cv.findContours(edges, cv.RETR_LIST, cv.CHAIN_APPROX_NONE)
    polylines = []

    for c in cnts:
        if len(c) < 8: #if the line is less than 8px long, ignore.
            continue
        approx = cv.approxPolyDP(c, 2.0, False)
        pts = approx[:,0,:].astype(np.float32)  # Nx2
        # jevn undersampling hvis veldig lang:
        if len(pts) > 200:
            idx = np.linspace(0, len(pts)-1, 200).astype(int)
            pts = pts[idx]
        polylines.append(pts)
    print(contours_edge) #showing the image in pop-up for tuning.

    cv.imshow("test", image) #Vis bildet som skal tegnes
    #Vis polylines:
    blank = 255 * np.ones_like(image)
    for pts in polylines:
        # draw polyline (1 px tykk, svart)
        cv.polylines(blank, [pts.astype(np.int32)], isClosed=False, color=0, thickness=1)
    cv.imshow("Rendret strektegning (polylines)", blank)

    cv.waitKey(0)
    cv.destroyAllWindows() #Image pop-up closes at key-press
    
def scale_to_a4(polylines_px, src_w, src_h, margin=MARGIN):
    """Skaler fra piksler til A4-mm (bevar aspekt, sentrer, snu Y så +Y blir oppover på arket)."""
    sx = DRAW_W / src_w
    sy = DRAW_H / src_h
    s  = min(sx, sy)
    tx = margin + (DRAW_W  - s*src_w)/2.0
    ty = margin + (DRAW_H  - s*src_h)/2.0
    out = []
    for poly in polylines_px:
        xy = poly.copy()
        xy[:,0] = s*xy[:,0] + tx
        xy[:,1] = s*(src_h - xy[:,1]) + ty  # snu y-akse: bilde-topp -> +Y
        out.append(xy)
    return out
    
image_to_polylines()
